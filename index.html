<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡¾å®¢è§‚çœ‹æ—¶é•¿ç­›é€‰ç³»ç»Ÿ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9ff;
    }
    
    .upload-area:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }
    
    .upload-area.active {
      border-color: #4caf50;
      background: #e8f5e9;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Consolas', monospace;
      resize: vertical;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    
    .input-group input {
      width: 200px;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-success {
      background: #4caf50;
      color: white;
    }
    
    .btn-success:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    .result-area {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .result-empty {
      color: #999;
      text-align: center;
      padding: 40px;
      font-size: 16px;
    }
    
    .result-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.2s;
    }
    
    .result-item:hover {
      transform: translateX(5px);
    }
    
    .result-name {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }
    
    .result-time {
      color: #e74c3c;
      font-weight: 500;
      font-size: 14px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .alert {
      padding: 12px 20px;
      border-radius: 8px;
      margin-top: 15px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      animation: slideIn 0.3s;
      line-height: 1.5;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .file-info {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 8px 15px;
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .remove-file-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    
    .remove-file-btn:hover {
      background: #c82333;
    }
    
    .tip {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .step-number {
      background: #667eea;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š é¡¾å®¢è§‚çœ‹æ—¶é•¿ç­›é€‰ç³»ç»Ÿ</h1>
      <p>å¿«é€Ÿç­›é€‰è§‚çœ‹æ—¶é•¿ä¸è¾¾æ ‡çš„ç›®æ ‡å®¢æˆ·</p>
    </div>
    
    <!-- æ­¥éª¤1ï¼šä¸Šä¼ é¡¾å®¢åå• -->
    <div class="card">
      <div class="card-title">
        <span class="step-number">1</span>
        <span>ä¸Šä¼ é¡¾å®¢åå•</span>
      </div>
      <div class="input-group">
        <label>è¾“å…¥ç›®æ ‡é¡¾å®¢å§“åï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
        <textarea id="customerList" placeholder="å¼ ä¸‰&#10;æå››&#10;ç‹äº”&#10;èµµå…­&#10;..."></textarea>
        <div class="tip">
          ğŸ’¡ æç¤ºï¼šç²˜è´´å§“ååˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªå§“åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨
        </div>
      </div>
      <button class="btn btn-success" id="saveCustomerBtn">
        <span>ğŸ’¾</span>
        <span>ä¿å­˜åå•</span>
      </button>
      <div id="customerStatus"></div>
    </div>
    
    <!-- æ­¥éª¤2ï¼šè®¾ç½®æ—¶é•¿é˜ˆå€¼ -->
    <div class="card">
      <div class="card-title">
        <span class="step-number">2</span>
        <span>è®¾ç½®è§‚çœ‹æ—¶é•¿é˜ˆå€¼</span>
      </div>
      <div class="input-group">
        <label>æœ€å°è§‚çœ‹æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
        <input type="number" id="thresholdInput" value="40" min="0" step="1" />
        <div class="tip">
          ğŸ’¡ ç­›é€‰é€»è¾‘ï¼šæ€»è§‚çœ‹æ—¶é•¿ï¼ˆç›´æ’­ + å›æ”¾ï¼‰<strong>å°äº</strong>æ­¤å€¼çš„å®¢æˆ·
        </div>
      </div>
    </div>
    
    <!-- æ­¥éª¤3ï¼šä¸Šä¼ Excel -->
    <div class="card">
      <div class="card-title">
        <span class="step-number">3</span>
        <span>ä¸Šä¼  Excel æ–‡ä»¶</span>
      </div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“</div>
        <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
          ç‚¹å‡»æˆ–æ‹–æ‹½ Excel æ–‡ä»¶åˆ°è¿™é‡Œ
        </p>
        <p style="font-size: 14px; color: #999;">
          æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼<br>
          éœ€åŒ…å«åˆ—ï¼š<strong>ç›´æ’­è§‚çœ‹æ—¶é•¿</strong>ã€<strong>å›æ”¾è§‚çœ‹æ—¶é•¿</strong>ã€<strong>ä¼šå‘˜å§“å</strong>
        </p>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" />
      <div id="fileInfo"></div>
      <div id="uploadStatus"></div>
    </div>
    
    <!-- ç­›é€‰ç»“æœ -->
    <div class="card" id="resultCard" style="display: none;">
      <div class="card-title">
        <span>âœ…</span>
        <span>ç­›é€‰ç»“æœ</span>
      </div>
      
      <div class="stats">
        <div class="stat-box">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">Excelæ€»äººæ•°</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="targetCount">0</div>
          <div class="stat-label">ç›®æ ‡å®¢æˆ·æ•°</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="filteredCount">0</div>
          <div class="stat-label">è§‚çœ‹ä¸è¶³äººæ•°</div>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #333;">ğŸ“‹ è§‚çœ‹æ—¶é•¿ä¸è¶³çš„å®¢æˆ·æ˜ç»†ï¼š</h3>
        <div class="result-area" id="resultArea"></div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-primary" id="exportTxtBtn">
          <span>ğŸ“„</span>
          <span>å¯¼å‡ºä¸ºæ–‡æœ¬</span>
        </button>
        <button class="btn btn-primary" id="exportExcelBtn">
          <span>ğŸ“Š</span>
          <span>å¯¼å‡ºä¸ºExcel</span>
        </button>
        <button class="btn btn-secondary" id="copyBtn">
          <span>ğŸ“‹</span>
          <span>å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    let customerListData = [];
    let excelData = [];
    let filteredResults = [];
    
    // å…ƒç´ å¼•ç”¨
    const customerList = document.getElementById('customerList');
    const saveCustomerBtn = document.getElementById('saveCustomerBtn');
    const customerStatus = document.getElementById('customerStatus');
    const thresholdInput = document.getElementById('thresholdInput');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const uploadStatus = document.getElementById('uploadStatus');
    const resultCard = document.getElementById('resultCard');
    const resultArea = document.getElementById('resultArea');
    const totalCount = document.getElementById('totalCount');
    const targetCount = document.getElementById('targetCount');
    const filteredCount = document.getElementById('filteredCount');
    const exportTxtBtn = document.getElementById('exportTxtBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    const copyBtn = document.getElementById('copyBtn');
    
    // åŠ è½½æœ¬åœ°å­˜å‚¨çš„åå•
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('customerList');
      if (saved) {
        customerList.value = saved;
        customerListData = saved.split('\n').map(s => s.trim()).filter(s => s);
        showAlert(customerStatus, `å·²è‡ªåŠ¨åŠ è½½ ${customerListData.length} ä½é¡¾å®¢`, 'info');
      }
    });
    
    // ä¿å­˜é¡¾å®¢åå•
    saveCustomerBtn.addEventListener('click', () => {
      const text = customerList.value.trim();
      if (!text) {
        showAlert(customerStatus, 'âŒ è¯·è¾“å…¥é¡¾å®¢åå•ï¼', 'error');
        return;
      }
      
      customerListData = text.split('\n').map(s => s.trim()).filter(s => s);
      localStorage.setItem('customerList', text);
      showAlert(customerStatus, `âœ… å·²ä¿å­˜ ${customerListData.length} ä½é¡¾å®¢åˆ°æœ¬åœ°å­˜å‚¨`, 'success');
    });
    
    // ä¸Šä¼ åŒºåŸŸäº¤äº’
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('active');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('active');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('active');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });
    
    // å¤„ç†Excelæ–‡ä»¶
    async function handleFile(file) {
      if (!file.name.match(/\.(xlsx|xls)$/)) {
        showAlert(uploadStatus, 'âŒ è¯·ä¸Šä¼  Excel æ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰', 'error');
        return;
      }
      
      if (customerListData.length === 0) {
        showAlert(uploadStatus, 'âŒ è¯·å…ˆä¿å­˜é¡¾å®¢åå•ï¼', 'error');
        return;
      }
      
      fileInfo.innerHTML = `
        <div class="file-info">
          ğŸ“„ ${file.name} (${(file.size / 1024).toFixed(2)} KB)
          <button class="remove-file-btn" onclick="removeFile()">âœ• ç§»é™¤</button>
        </div>
      `;
      showAlert(uploadStatus, 'â³ æ­£åœ¨è¯»å–å’Œå¤„ç† Excel æ–‡ä»¶...', 'info');
      
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { 
          type: 'array',
          cellDates: true,
          cellNF: false,
          cellText: true,
          defval: ''
        });
        
        // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        console.log('=== Excel åŸå§‹æ•°æ®è°ƒè¯• ===');
        console.log('å·¥ä½œè¡¨åç§°:', firstSheetName);
        console.log('å·¥ä½œè¡¨èŒƒå›´:', worksheet['!ref']);
        
        // è¯»å–å‰10è¡ŒåŸå§‹æ•°æ®çœ‹çœ‹
        const rawData = XLSX.utils.sheet_to_json(worksheet, {
          header: 1,  // è¿”å›äºŒç»´æ•°ç»„ï¼Œä¸è§£æåˆ—å
          raw: false,
          defval: '',
          blankrows: true
        });
        
        console.log('å‰10è¡ŒåŸå§‹æ•°æ®:');
        rawData.slice(0, 10).forEach((row, idx) => {
          console.log(`ç¬¬${idx + 1}è¡Œ:`, row);
        });
        
        // å°è¯•ä¸åŒçš„æ–¹å¼è¯»å–
        let jsonData = null;
        let headerRow = 0;
        
        // æŸ¥æ‰¾åŒ…å«"ä¼šå‘˜å§“å"çš„è¡Œä½œä¸ºè¡¨å¤´
        for (let i = 0; i < Math.min(rawData.length, 20); i++) {
          const row = rawData[i];
          const rowStr = row.join('').toLowerCase();
          if (rowStr.includes('ä¼šå‘˜') || rowStr.includes('å§“å') || rowStr.includes('ç›´æ’­') || rowStr.includes('æ—¶é•¿')) {
            headerRow = i;
            console.log(`æ‰¾åˆ°å¯èƒ½çš„è¡¨å¤´è¡Œ: ç¬¬${i + 1}è¡Œ`, row);
            break;
          }
        }
        
        // ä»æ‰¾åˆ°çš„è¡¨å¤´è¡Œå¼€å§‹è¯»å–
        if (headerRow > 0) {
          console.log(`è·³è¿‡å‰${headerRow}è¡Œï¼Œä»ç¬¬${headerRow + 1}è¡Œå¼€å§‹è¯»å–æ•°æ®`);
          jsonData = XLSX.utils.sheet_to_json(worksheet, {
            range: headerRow,
            raw: false,
            defval: '',
            blankrows: false
          });
        } else {
          jsonData = XLSX.utils.sheet_to_json(worksheet, {
            raw: false,
            defval: '',
            blankrows: false
          });
        }
        
        console.log('è¯»å–åˆ°çš„æ•°æ®è¡Œæ•°:', jsonData.length);
        console.log('ç¬¬ä¸€è¡Œæ•°æ®ç¤ºä¾‹:', jsonData[0]);
        
        if (jsonData.length === 0) {
          showAlert(uploadStatus, 
            `âŒ Excel æ–‡ä»¶æ— æ³•è¯»å–æ•°æ®ï¼<br><br>
            è¯·æ£€æŸ¥ï¼š<br>
            1. æ–‡ä»¶æ˜¯å¦æœ‰æ•°æ®è¡Œ<br>
            2. ç¬¬ä¸€è¡Œæ˜¯å¦æ˜¯åˆ—å<br>
            3. æ˜¯å¦æœ‰åˆå¹¶å•å…ƒæ ¼<br><br>
            ğŸ’¡ å»ºè®®ï¼šå¤åˆ¶éœ€è¦çš„3åˆ—åˆ°æ–°Excelä¸­`, 
            'error'
          );
          return;
        }
        
        // æ£€æŸ¥å¿…éœ€çš„åˆ—
        const firstRow = jsonData[0];
        const availableColumns = Object.keys(firstRow);
        
        console.log('å¯ç”¨çš„åˆ—å:', availableColumns);
        console.log('åˆ—åæ•°é‡:', availableColumns.length);
        
        // æ™ºèƒ½æŸ¥æ‰¾åˆ—åï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
        const nameColumn = availableColumns.find(col => {
          const c = col.toLowerCase();
          return c.includes('å§“å') || c.includes('ä¼šå‘˜') || c === 'å§“å' || c === 'ä¼šå‘˜';
        });
        
        const liveColumn = availableColumns.find(col => {
          const c = col.toLowerCase();
          return c.includes('ç›´æ’­') && c.includes('æ—¶é•¿');
        });
        
        const replayColumn = availableColumns.find(col => {
          const c = col.toLowerCase();
          return c.includes('å›æ”¾') && c.includes('æ—¶é•¿');
        });
        
        console.log('æ‰¾åˆ°çš„åˆ—åæ˜ å°„:', { 
          å§“ååˆ—: nameColumn, 
          ç›´æ’­åˆ—: liveColumn, 
          å›æ”¾åˆ—: replayColumn 
        });
        
        if (!nameColumn || !liveColumn || !replayColumn) {
          // æ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©ç•Œé¢
          showColumnSelector(availableColumns, jsonData);
          return;
        }
        
        // å¤„ç†æ•°æ®ï¼šç»Ÿä¸€åˆ—åå¹¶è§£ææ—¶é•¿
        excelData = jsonData.map(row => {
          return {
            'ä¼šå‘˜å§“å': row[nameColumn],
            'ç›´æ’­è§‚çœ‹æ—¶é•¿': parseTimeString(row[liveColumn]),
            'å›æ”¾è§‚çœ‹æ—¶é•¿': parseTimeString(row[replayColumn])
          };
        }).filter(row => row['ä¼šå‘˜å§“å']); // è¿‡æ»¤æ‰ç©ºè¡Œ
        
        console.log('å¤„ç†åçš„æ•°æ®ç¤ºä¾‹:', excelData[0]);
        console.log('æœ‰æ•ˆæ•°æ®æ¡æ•°:', excelData.length);
        
        if (excelData.length === 0) {
          showAlert(uploadStatus, 'âŒ æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼', 'error');
          return;
        }
        
        processData();
        
      } catch (error) {
        console.error('è¯»å–å¤±è´¥:', error);
        showAlert(uploadStatus, 'âŒ è¯»å– Excel å¤±è´¥ï¼š' + error.message + '<br>è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåæˆ–å—ä¿æŠ¤', 'error');
      }
    }
    
    // æ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©åˆ—çš„ç•Œé¢
    function showColumnSelector(columns, data) {
      const selectorHTML = `
        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-top: 15px;">
          <h4 style="margin-bottom: 15px; color: #856404;">âš ï¸ æ— æ³•è‡ªåŠ¨è¯†åˆ«åˆ—åï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ï¼š</h4>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ä¼šå‘˜å§“ååˆ—ï¼š</label>
            <select id="nameColumnSelect" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
              ${columns.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç›´æ’­è§‚çœ‹æ—¶é•¿åˆ—ï¼š</label>
            <select id="liveColumnSelect" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
              ${columns.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">å›æ”¾è§‚çœ‹æ—¶é•¿åˆ—ï¼š</label>
            <select id="replayColumnSelect" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
              ${columns.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
          </div>
          
          <button class="btn btn-primary" onclick="confirmColumnSelection()">
            <span>âœ…</span>
            <span>ç¡®è®¤å¹¶å¼€å§‹å¤„ç†</span>
          </button>
        </div>
      `;
      
      uploadStatus.innerHTML = selectorHTML;
      
      // ä¿å­˜æ•°æ®ä¾›åç»­ä½¿ç”¨
      window.tempExcelData = data;
      window.tempColumns = columns;
    }
    
    // ç¡®è®¤åˆ—é€‰æ‹©
    window.confirmColumnSelection = function() {
      const nameColumn = document.getElementById('nameColumnSelect').value;
      const liveColumn = document.getElementById('liveColumnSelect').value;
      const replayColumn = document.getElementById('replayColumnSelect').value;
      
      console.log('ç”¨æˆ·é€‰æ‹©çš„åˆ—:', { nameColumn, liveColumn, replayColumn });
      
      // å¤„ç†æ•°æ®
      excelData = window.tempExcelData.map(row => {
        return {
          'ä¼šå‘˜å§“å': row[nameColumn],
          'ç›´æ’­è§‚çœ‹æ—¶é•¿': parseTimeString(row[liveColumn]),
          'å›æ”¾è§‚çœ‹æ—¶é•¿': parseTimeString(row[replayColumn])
        };
      }).filter(row => row['ä¼šå‘˜å§“å']);
      
      console.log('å¤„ç†åçš„æ•°æ®:', excelData.length, 'æ¡');
      
      if (excelData.length === 0) {
        showAlert(uploadStatus, 'âŒ æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼', 'error');
        return;
      }
      
      processData();
    };
    
    // è§£ææ—¶é•¿å­—ç¬¦ä¸² "0å°æ—¶49åˆ†56ç§’" æˆ– æ•°å­—
    function parseTimeString(timeStr) {
      if (!timeStr) return 0;
      
      // å¦‚æœå·²ç»æ˜¯æ•°å­—ï¼Œç›´æ¥è¿”å›
      if (typeof timeStr === 'number') return timeStr;
      
      const str = timeStr.toString().trim();
      
      // åŒ¹é…æ ¼å¼ï¼šXå°æ—¶Yåˆ†Zç§’
      const match = str.match(/(\d+)å°æ—¶(\d+)åˆ†(\d+)ç§’/);
      if (match) {
        const hours = parseInt(match[1]) || 0;
        const minutes = parseInt(match[2]) || 0;
        const seconds = parseInt(match[3]) || 0;
        return hours * 60 + minutes + seconds / 60;
      }
      
      // å°è¯•ç›´æ¥è½¬æ¢ä¸ºæ•°å­—
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    }
    
    // ç§»é™¤æ–‡ä»¶
    function removeFile() {
      fileInput.value = '';
      fileInfo.innerHTML = '';
      uploadStatus.innerHTML = '';
      resultCard.style.display = 'none';
      excelData = [];
      filteredResults = [];
    }
    
    // å¤„ç†æ•°æ®
    function processData() {
      const threshold = parseFloat(thresholdInput.value) || 0;
      
      console.log('å¼€å§‹å¤„ç†æ•°æ®ï¼Œé˜ˆå€¼:', threshold);
      console.log('é¡¾å®¢åå•:', customerListData);
      console.log('Excelæ•°æ®æ¡æ•°:', excelData.length);
      
      // ç­›é€‰é€»è¾‘
      filteredResults = excelData.filter(row => {
        const name = (row['ä¼šå‘˜å§“å'] || '').toString().trim();
        const liveTime = row['ç›´æ’­è§‚çœ‹æ—¶é•¿'] || 0;
        const replayTime = row['å›æ”¾è§‚çœ‹æ—¶é•¿'] || 0;
        const totalTime = liveTime + replayTime;
        
        const inList = customerListData.includes(name);
        const belowThreshold = totalTime < threshold;
        
        if (inList) {
          console.log(`${name}: ç›´æ’­${liveTime.toFixed(1)}åˆ† + å›æ”¾${replayTime.toFixed(1)}åˆ† = æ€»${totalTime.toFixed(1)}åˆ†, ä½äºé˜ˆå€¼: ${belowThreshold}`);
        }
        
        // å¿…é¡»åœ¨é¡¾å®¢åå•ä¸­ ä¸” è§‚çœ‹æ—¶é•¿ä¸è¶³
        return inList && belowThreshold;
      }).map(row => ({
        name: row['ä¼šå‘˜å§“å'],
        liveTime: row['ç›´æ’­è§‚çœ‹æ—¶é•¿'] || 0,
        replayTime: row['å›æ”¾è§‚çœ‹æ—¶é•¿'] || 0,
        totalTime: (row['ç›´æ’­è§‚çœ‹æ—¶é•¿'] || 0) + (row['å›æ”¾è§‚çœ‹æ—¶é•¿'] || 0)
      }));
      
      // æŒ‰æ€»æ—¶é•¿å‡åºæ’åº
      filteredResults.sort((a, b) => a.totalTime - b.totalTime);
      
      // ç»Ÿè®¡
      const targetInExcel = excelData.filter(row => {
        const name = (row['ä¼šå‘˜å§“å'] || '').toString().trim();
        return customerListData.includes(name);
      });
      
      console.log('ç­›é€‰ç»“æœ:', filteredResults.length);
      
      totalCount.textContent = excelData.length;
      targetCount.textContent = targetInExcel.length;
      filteredCount.textContent = filteredResults.length;
      
      // æ˜¾ç¤ºç»“æœ
      displayResults();
      resultCard.style.display = 'block';
      showAlert(uploadStatus, `âœ… å¤„ç†å®Œæˆï¼ç­›é€‰å‡º ${filteredResults.length} ä½è§‚çœ‹æ—¶é•¿ä¸è¶³çš„å®¢æˆ·`, 'success');
      
      // æ»šåŠ¨åˆ°ç»“æœ
      resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // æ˜¾ç¤ºç»“æœ
    function displayResults() {
      if (filteredResults.length === 0) {
        resultArea.innerHTML = '<div class="result-empty">ğŸ‰ å¤ªæ£’äº†ï¼æ‰€æœ‰ç›®æ ‡å®¢æˆ·çš„è§‚çœ‹æ—¶é•¿éƒ½è¾¾æ ‡äº†ï¼</div>';
        return;
      }
      
      resultArea.innerHTML = filteredResults.map(item => `
        <div class="result-item">
          <span class="result-name">${item.name}</span>
          <span class="result-time">
            æ€»: ${item.totalTime.toFixed(1)}åˆ†é’Ÿ 
            (ç›´æ’­: ${item.liveTime.toFixed(1)}, å›æ”¾: ${item.replayTime.toFixed(1)})
          </span>
        </div>
      `).join('');
    }
    
    // å¯¼å‡ºä¸ºæ–‡æœ¬
    exportTxtBtn.addEventListener('click', () => {
      if (filteredResults.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return;
      }
      
      const header = 'å§“å\tç›´æ’­è§‚çœ‹æ—¶é•¿(åˆ†é’Ÿ)\tå›æ”¾æ’­æ”¾æ—¶é•¿(åˆ†é’Ÿ)\tæ€»è§‚çœ‹æ—¶é•¿(åˆ†é’Ÿ)\n';
      const text = filteredResults.map(item => 
        `${item.name}\t${item.liveTime.toFixed(1)}\t${item.replayTime.toFixed(1)}\t${item.totalTime.toFixed(1)}`
      ).join('\n');
      
      downloadFile(`${header}${text}`, `è§‚çœ‹æ—¶é•¿ä¸è¶³å®¢æˆ·_${getDateString()}.txt`, 'text/plain');
    });
    
    // å¯¼å‡ºä¸ºExcel
    exportExcelBtn.addEventListener('click', () => {
      if (filteredResults.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return;
      }
      
      const exportData = filteredResults.map(item => ({
        'å§“å': item.name,
        'ç›´æ’­è§‚çœ‹æ—¶é•¿(åˆ†é’Ÿ)': item.liveTime.toFixed(1),
        'å›æ”¾æ’­æ”¾æ—¶é•¿(åˆ†é’Ÿ)': item.replayTime.toFixed(1),
        'æ€»è§‚çœ‹æ—¶é•¿(åˆ†é’Ÿ)': item.totalTime.toFixed(1)
      }));
      
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ç­›é€‰ç»“æœ");
      XLSX.writeFile(wb, `è§‚çœ‹æ—¶é•¿ä¸è¶³å®¢æˆ·_${getDateString()}.xlsx`);
    });
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    copyBtn.addEventListener('click', async () => {
      if (filteredResults.length === 0) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„æ•°æ®');
        return;
      }
      
      const text = filteredResults.map(item => 
        `${item.name}\t${item.totalTime.toFixed(1)}åˆ†é’Ÿ`
      ).join('\n');
      
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.innerHTML = '<span>âœ…</span><span>å·²å¤åˆ¶ï¼</span>';
        setTimeout(() => {
          copyBtn.innerHTML = '<span>ğŸ“‹</span><span>å¤åˆ¶åˆ°å‰ªè´´æ¿</span>';
        }, 2000);
      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      }
    });
    
    // è¾…åŠ©å‡½æ•°
    function showAlert(container, message, type) {
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }
    
    function getDateString() {
      const now = new Date();
      return `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    }
    
    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
